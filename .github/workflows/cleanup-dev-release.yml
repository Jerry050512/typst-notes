name: Cleanup old dev releases

on:
  schedule:
    - cron: "0 4 * * 0"   # 每周日 04:00 UTC
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete dev releases older than 30 days
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -e

          NOW=$(date -u +%s)
          THIRTY_DAYS=$((30 * 24 * 3600))

          releases=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$OWNER/$REPO/releases?per_page=100")

          echo "$releases" | jq -c '.[]' | while read release; do
            tag=$(echo "$release" | jq -r '.tag_name')
            id=$(echo "$release" | jq -r '.id')
            published=$(echo "$release" | jq -r '.published_at')

            # 只处理 dev- 开头的 tag
            if [[ "$tag" != dev-* ]]; then
              continue
            fi

            published_ts=$(date -d "$published" +%s)
            age=$((NOW - published_ts))

            if (( age > THIRTY_DAYS )); then
              echo "Deleting release $tag (id=$id)"

              # 删除 release
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$OWNER/$REPO/releases/$id"

              # 删除 tag
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$OWNER/$REPO/git/refs/tags/$tag"
            fi
          done
